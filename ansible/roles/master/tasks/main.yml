---
- name: 'cluster bootstrap'
  ansible.builtin.shell: 
    cmd: "sudo kubeadm init --pod-network-cidr {{ hostvars['localhost']['cidr'] }} --apiserver-advertise-address {{ hostvars['localhost']['lst_ips'][0] }} --kubernetes-version {{ hostvars['localhost']['k8s_version'] }} --node-name {{ hostvars['localhost']['lst_servers'][0] }} --ignore-preflight-errors=all"
    chdir: '/usr/bin'
  async: 90
  poll: 0

- name: 'configure root account as cluster admin'
  ansible.builtin.file:
    path: '/root/.kube'
    state: directory

- name: 'copy user config file'
  ansible.builtin.copy:
    remote_src: 'yes'
    src: '/etc/kubernetes/admin.conf'
    dest: '/root/.kube/config'
    owner: 'root'
    group: 'root'
    
- name: 'calico yaml copy'
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: 'root'
    group: 'root'
  with_items:
    - {src: './roles/master/files/calico.yaml', dest: '/root/calico.yaml'}
    - {src: './roles/master/files/java-hw.yml', dest: '/root/java-hw.yml'}

- name: 'calico pod network deployment'
  ansible.builtin.shell: 
    cmd: "sudo kubectl create -f /root/calico.yaml"
    chdir: '/usr/bin'
  async: 90
  poll: 0 

- name: 'print-join-command'
  ansible.builtin.shell: 
    cmd: 'sudo kubeadm token create --print-join-command'
    chdir: '/usr/bin'
  async: 90
  poll: 0 
  register: 'joincommand'

- name: 'store variables'
  set_fact:
    joinmaster: "{{ joincommand.stdout }}"